# Kirari Shuttle Record App - デプロイ手順書

このアプリは「Google Apps Script (バックエンド)」と「GitHub Pages (フロントエンド)」の2つを組み合わせて動作します。以下の手順でセットアップを行ってください。

## 1. Google Sheets & GAS の準備

1.  **Google Sheets を新規作成**
    - 名前例: `送迎記録管理DB`
    - シートは空でOKです（スクリプトが自動生成します）。

2.  **スクリプトエディタを開く**
    - メニューの `拡張機能` > `Apps Script` をクリック。

3.  **スクリプトファイルのコピー**
    - 以下のファイルをエディタに作成し、コードをコピペしてください。
    - `Code.gs` (メインスクリプト)
    - `SheetHelper.gs` (ヘルパー)
    - `Setup.gs` (セットアップ用)

4.  **初回セットアップ実行**
    - エディタ上のプルダウンで `setup` 関数を選択し、「実行」をクリック。
    - 権限確認が表示されたら許可してください。
    - 実行完了後、スプレッドシートに戻ると「事業所マスタ」などのシートが作成されています。
    - ※マスタシートにテストデータが入っています。必要に応じて修正してください。

5.  **Webアプリとしてデプロイ（初回のみ「新しいデプロイ」）**
    - 右上の `デプロイ` > `新しいデプロイ` をクリック。
    - 種類の選択: `ウェブアプリ`
    - 説明: `v1` など
    - 次のユーザーとして実行: **自分** (重要)
    - アクセスできるユーザー: **Googleアカウントを持つ全員** (または全ユーザー)
        - ※ドライバーがGoogleアカウントを持っていない場合は「全員」推奨ですが、セキュリティ上は「Googleアカウントを持つ全員」としてドライバーにもアカウント作成を推奨します。
    - `デプロイ` をクリックし、**ウェブアプリURL** をコピーしてください。

6.  **運用時の反映ルール（重要）**
    - コード更新時は **`新しいデプロイ` を作らず**、`デプロイ` > `デプロイを管理` から **既存のWebアプリデプロイを編集して更新** してください。
    - これにより、運用中のURL（`/macros/s/<deployment-id>/exec`）を変えずに最新版コードを反映できます。
    - URLを差し替える運用にすると、PWA側設定との不整合で管理画面操作がブロックされるなどの不具合切り分けが難しくなるため、**固定URL運用** を標準とします。


7.  **PWAの `API_URL` とデプロイ版の対応確認（`getApiInfo`）**
    - `pwa/common.js` の `API_URL` が、手順5〜6で更新した **同一WebアプリURL** を向いていることを確認します。
    - ブラウザで以下URLを開き、`success: true` と `data.supportedActions` を確認します。  
      `https://script.google.com/macros/s/<deployment-id>/exec?action=getApiInfo`
    - `supportedActions` に最低限 `updateMasterData` / `bulkUpdateSchedules` / `createTemplate` が含まれていれば、管理画面の必須操作に対応した版です。
    - これらが含まれない場合は、GAS側を再デプロイ（既存デプロイを編集して更新）するか、PWA側 `API_URL` の設定先を見直してください。

## 2. PWA (フロントエンド) の準備

1.  **接続先URLの設定**
    - PC上の `pwa/common.js` をテキストエディタで開きます。
    - 冒頭の `const API_URL = 'YOUR_GAS_WEB_APP_URL';` の部分を、先ほどコピーしたURLに書き換えて保存します。

2.  **GitHub Pages へのアップロード**
    - GitHub にログインし、新しいリポジトリを作成します（例: `kirari-shuttle-pwa`）。
    - `Public` (公開) に設定します。
    - PC上の `pwa` フォルダの中身（index.html, style.css, app.js, manifest.json, sw.js, iconsフォルダ）をすべてアップロードします。
    - または、GitHub Desktop などを使って Push します。

3.  **Pages の有効化**
    - リポジトリの `Settings` > `Pages` を開きます。
    - Source: `Deploy from a branch`
    - Branch: `main` (または `master`) / `(root)`
    - Save をクリック。
    - 数分待つと、上部に「Your site is live at...」とURLが表示されます。これがアプリのURLです。

## 3. アプリのインストール (Android)

1.  Androidスマホの Chrome で、発行されたアプリURLを開きます。
2.  画面下部またはメニューに「ホーム画面に追加」または「アプリをインストール」が表示されます。
3.  タップしてインストールすると、ホーム画面にアイコンが追加されます。
4.  以降はアイコンから起動し、全画面で利用できます。

## 4. 運用開始

- **マスタ登録**: Google Sheets の「利用者マスタ」「車両マスタ」に行を追加・編集してください。
- **予定作成**: 「送迎予定」シートに日付・利用者・車両・予定時刻を入力します（PC作業）。
- **アプリ利用**: ドライバーがアプリを開いてチェックを行います。

## トラブルシューティング

- **「同期失敗」と出る**: 電波状況を確認してください。電波が良い場所で再度同期ボタンを押してください。
- **データが表示されない**: 初回起動時にデータ取得に失敗した可能性があります。再読み込みしてください。
